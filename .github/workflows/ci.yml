name: 'pr'

on:
  pull_request:
    branches:
      - master
    types: [opened, synchronize, closed]

permissions:
  id-token: write
  packages: write
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: "checkout"
        uses: actions/checkout@v4

      - name: validate
        run: |
          .github/scripts/validate.sh

      - name: build
        run: |
          docker run \
            --interactive -v $(pwd):/workspace gcr.io/kaniko-project/executor:latest \
            --context . --dockerfile ./Dockerfile \
            --destination=ghcr.io/$GITHUB_REPOSITORY:$GITHUB_SHA \
            --no-push --tar-path image.tar

      - name: debug
        run: |
          ls -lah .

      - name: 'Login to GitHub Container Registry'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: release
        if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'master'
        run: |
          docker image load --input image.tar
          docker image tag $GITHUB_REPOSITORY:$GITHUB_SHA $GITHUB_REPOSITORY:$IMAGEVERSION
          docker push $GITHUB_REPOSITORY:$IMAGEVERSION

          set -e; awk 'NR==2 {print RT,$0}' RS="## [v|0-9]" OFS="" CHANGELOG.md > release_description.md
          cat release_description.md
          echo $IMAGEVERSION

          gh release create $IMAGEVERSION -F release_description.md -t $IMAGEVERSION


